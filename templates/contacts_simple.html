{% include 'components/head.html' %}

<body class="bg-light" dir="rtl">
    <!-- Navigation -->
    {% include 'components/unified_navigation.html' %}

    <div class="container-unified">
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-users me-3"></i><span data-i18n="contacts.management">{{ 'contacts.management' | translate }}</span>
            </h1>
            <p class="page-subtitle" data-i18n="contacts.manage_organize">{{ 'contacts.manage_organize' | translate }}</p>
        </div>

        <!-- Contacts Table -->
        <div class="card-unified">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-users me-2"></i><span data-i18n="contacts.list">{{ 'contacts.list' | translate }}</span>
                    <span class="badge bg-primary">{{ contacts|length }}</span>
                </h5>
            </div>
            <div class="card-body">
                {% if contacts %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th data-i18n="forms.name">{{ 'forms.name' | translate }}</th>
                                <th data-i18n="forms.email">{{ 'forms.email' | translate }}</th>
                                <th data-i18n="forms.phone">{{ 'forms.phone' | translate }}</th>
                                <th data-i18n="forms.company">{{ 'forms.company' | translate }}</th>
                                <th data-i18n="forms.language">{{ 'forms.language' | translate }}</th>
                                <th data-i18n="forms.status">{{ 'forms.status' | translate }}</th>
                                <th data-i18n="forms.actions">{{ 'forms.actions' | translate }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for contact in contacts %}
                            <tr>
                                <td>
                                    <strong>{{ contact.name }}</strong>
                                </td>
                                <td>
                                    {{ contact.email or '-' }}
                                </td>
                                <td>
                                    {{ contact.phone or '-' }}
                                </td>
                                <td>
                                    {{ contact.company or '-' }}
                                </td>
                                <td>
                                    <span class="badge bg-secondary">
                                        {{ 'العربية' if contact.language_preference == 'ar' else 'English' }}
                                    </span>
                                </td>
                                <td>
                                    {% if contact.is_active %}
                                        <span class="badge bg-success" data-i18n="forms.active">{{ 'forms.active' | translate }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary" data-i18n="forms.inactive">{{ 'forms.inactive' | translate }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="editContact({{ contact.id }}, '{{ contact.name }}', '{{ contact.email or '' }}', '{{ contact.phone or '' }}', '{{ contact.company or '' }}', '{{ contact.language_preference }}', {{ 'true' if contact.is_active else 'false' }}, {{ 'true' if contact.email_opt_in else 'false' }}, {{ 'true' if contact.sms_opt_in else 'false' }}, {{ 'true' if contact.whatsapp_opt_in else 'false' }}, '{{ contact.notes or '' }}')">
                                        <i class="fas fa-edit"></i> <span data-i18n="forms.edit">{{ 'forms.edit' | translate }}</span>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted" data-i18n="contacts.no_contacts">{{ 'contacts.no_contacts' | translate }}</h5>
                    <p class="text-muted" data-i18n="contacts.no_contacts_added">{{ 'contacts.no_contacts_added' | translate }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Edit Contact Modal -->
    <div class="modal fade" id="editContactModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form method="POST" id="editContactForm">
                    <div class="modal-header">
                        <h5 class="modal-title" data-i18n="contacts.edit_contact">{{ 'contacts.edit_contact' | translate }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label" data-i18n="forms.name_required">{{ 'forms.name_required' | translate }}</label>
                                    <input type="text" class="form-control" name="name" id="editName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label" data-i18n="forms.company">{{ 'forms.company' | translate }}</label>
                                    <input type="text" class="form-control" name="company" id="editCompany">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label" data-i18n="forms.email">{{ 'forms.email' | translate }}</label>
                                    <input type="email" class="form-control" name="email" id="editEmail">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label" data-i18n="forms.phone">{{ 'forms.phone' | translate }}</label>
                                    <input type="tel" class="form-control" name="phone" id="editPhone">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label" data-i18n="forms.preferred_language">{{ 'forms.preferred_language' | translate }}</label>
                                    <select class="form-select" name="language_preference" id="editLanguage">
                                        <option value="ar" data-i18n="language.arabic">{{ 'language.arabic' | translate }}</option>
                                        <option value="en" data-i18n="language.english">{{ 'language.english' | translate }}</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label" data-i18n="forms.status">{{ 'forms.status' | translate }}</label>
                                    <select class="form-select" name="is_active" id="editStatus">
                                        <option value="true" data-i18n="forms.active">{{ 'forms.active' | translate }}</option>
                                        <option value="false" data-i18n="forms.inactive">{{ 'forms.inactive' | translate }}</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" data-i18n="contacts.communication_preferences">{{ 'contacts.communication_preferences' | translate }}</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="email_opt_in" id="editEmailOpt">
                                <label class="form-check-label" for="editEmailOpt" data-i18n="forms.email">{{ 'forms.email' | translate }}</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="sms_opt_in" id="editSmsOpt">
                                <label class="form-check-label" for="editSmsOpt" data-i18n="contacts.sms">{{ 'contacts.sms' | translate }}</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="whatsapp_opt_in" id="editWhatsappOpt">
                                <label class="form-check-label" for="editWhatsappOpt">واتساب</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ملاحظات</label>
                            <textarea class="form-control" name="notes" id="editNotes" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                        <button type="submit" class="btn btn-primary">حفظ التغييرات</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function editContact(id, name, email, phone, company, language, isActive, emailOpt, smsOpt, whatsappOpt, notes) {
            // Set form action
            document.getElementById('editContactForm').action = `/contacts/edit/${id}`;
            
            // Fill form fields
            document.getElementById('editName').value = name;
            document.getElementById('editEmail').value = email;
            document.getElementById('editPhone').value = phone;
            document.getElementById('editCompany').value = company;
            document.getElementById('editLanguage').value = language;
            document.getElementById('editStatus').value = isActive;
            document.getElementById('editEmailOpt').checked = emailOpt === 'true';
            document.getElementById('editSmsOpt').checked = smsOpt === 'true';
            document.getElementById('editWhatsappOpt').checked = whatsappOpt === 'true';
            document.getElementById('editNotes').value = notes;
            
            // Show modal
            new bootstrap.Modal(document.getElementById('editContactModal')).show();
        }
    </script>
    
    {% include 'components/scripts.html' %}
</body>
</html>