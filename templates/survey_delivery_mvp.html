<!DOCTYPE html>
<html lang="{{ get_language_info().code }}" dir="{{ get_language_info().direction }}">
<head>
    {% include 'components/head.html' %}
    <title>{{ 'surveys.delivery_title' | translate }} - {{ 'app.name' | translate }}</title>
</head>
<body>
    {% include 'components/unified_navigation.html' %}
    {% include 'components/survey_header.html' %}
    {% include 'components/survey_actions.html' %}
    
    <div class="container-custom">

        <!-- Step 1: Create or Select Survey -->
        <div class="card-custom mb-4">
            <div class="card-header-custom">
                <h3 class="card-title">
                    <span class="step-number">1</span>
                    Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹
                </h3>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="survey-option">
                        <i class="fas fa-plus-circle text-primary-custom mb-3"></i>
                        <h4>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ø¬Ø¯ÙŠØ¯</h4>
                        <p>Ø§Ø³ØªØ®Ø¯Ù… Ù…Ù†Ø´Ø¦ Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹Ø§Øª Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ù…Ø®ØµØµ</p>
                        <a href="/surveys/builder" class="btn btn-primary-custom">
                            <i class="fas fa-edit me-2"></i>Ù…Ù†Ø´Ø¦ Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹Ø§Øª
                        </a>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="survey-option">
                        <i class="fas fa-list text-success-custom mb-3"></i>
                        <h4>Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ù…ÙˆØ¬ÙˆØ¯</h4>
                        <p>Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù„Ø¯ÙŠÙƒ</p>
                        <select class="form-select mb-3" id="existingSurvey">
                            <option value="">Ø§Ø®ØªØ± Ø§Ø³ØªØ·Ù„Ø§Ø¹...</option>
                            {% for survey in surveys %}
                            <option value="{{ survey.id }}" data-survey='{{ survey | tojson }}'>
                                {{ survey.title }} ({{ survey.questions_count }} Ø£Ø³Ø¦Ù„Ø©)
                            </option>
                            {% endfor %}
                            {% if not surveys %}
                            <option disabled>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø³ØªØ·Ù„Ø§Ø¹Ø§Øª Ù…ØªØ§Ø­Ø© - Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ø£ÙˆÙ„Ø§Ù‹</option>
                            {% endif %}
                        </select>
                        <button class="btn btn-success-custom" onclick="selectSurvey()">
                            <i class="fas fa-check me-2"></i>Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Generate Web Survey Link -->
        <div class="card-custom mb-4" id="step2" style="display: none;">
            <div class="card-header-custom">
                <h3 class="card-title">
                    <span class="step-number">2</span>
                    Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹
                </h3>
            </div>
            
            <div class="row">
                <div class="col-md-8">
                    <div class="survey-link-generator">
                        <h5>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯:</h5>
                        <div class="selected-survey-info mb-3" id="selectedSurveyInfo">
                            <!-- Survey info will be populated here -->
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Ø¹Ù†ÙˆØ§Ù† Ù…Ø®ØµØµ Ù„Ù„Ø±Ø§Ø¨Ø· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                                <input type="text" class="form-control" id="customSlug" placeholder="customer-survey-2024">
                                <small class="text-muted">Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ ØªÙØ±Ùƒ ÙØ§Ø±ØºØ§Ù‹</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                                <input type="datetime-local" class="form-control" id="expiryDate">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="requirePassword">
                                <label class="form-check-label" for="requirePassword">
                                    Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±
                                </label>
                            </div>
                            <input type="password" class="form-control mt-2" id="surveyPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="display: none;">
                        </div>
                        
                        <button class="btn btn-primary-custom btn-lg" onclick="generateSurveyLink()">
                            <i class="fas fa-link me-2"></i>Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹
                        </button>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="preview-box">
                        <h6>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹</h6>
                        <div class="survey-preview" id="surveyPreview">
                            <div class="text-center text-muted">
                                <i class="fas fa-eye-slash mb-2"></i>
                                <p>Ø§Ø®ØªØ± Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Distribution Options -->
        <div class="card-custom mb-4" id="step3" style="display: none;">
            <div class="card-header-custom">
                <h3 class="card-title">
                    <span class="step-number">3</span>
                    Ø·Ø±Ù‚ Ø§Ù„ØªÙˆØ²ÙŠØ¹
                </h3>
            </div>
            
            <!-- Generated Survey Link Display -->
            <div class="generated-link-section mb-4" id="generatedLinkSection" style="display: none;">
                <div class="alert alert-success d-flex align-items-center">
                    <i class="fas fa-check-circle me-3"></i>
                    <div class="flex-grow-1">
                        <strong>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ø¨Ù†Ø¬Ø§Ø­!</strong>
                        <div class="survey-url mt-2">
                            <input type="text" class="form-control" id="generatedUrl" readonly>
                        </div>
                    </div>
                    <button class="btn btn-outline-success btn-sm" onclick="copyToClipboard()">
                        <i class="fas fa-copy me-1"></i>Ù†Ø³Ø®
                    </button>
                </div>
            </div>
            
            <!-- Distribution Methods -->
            <div class="row">
                <!-- Email Distribution -->
                <div class="col-lg-6 mb-4">
                    <div class="distribution-card">
                        <div class="distribution-header">
                            <i class="fas fa-envelope text-primary-custom"></i>
                            <h4>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h4>
                        </div>
                        <div class="distribution-body">
                            <textarea class="form-control mb-3" rows="3" id="emailList" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (ÙˆØ§Ø­Ø¯ ÙÙŠ ÙƒÙ„ Ø³Ø·Ø±)&#10;example1@email.com&#10;example2@email.com"></textarea>
                            <div class="mb-3">
                                <input type="text" class="form-control mb-2" id="emailSubject" placeholder="Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø©" value="Ø¯Ø¹ÙˆØ© Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø§Ø³ØªØ·Ù„Ø§Ø¹">
                                <textarea class="form-control" rows="3" id="emailMessage" placeholder="Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ

Ù†ÙˆØ¯ Ø¯Ø¹ÙˆØªÙƒ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ù…Ù‡Ù…. Ù…Ø´Ø§Ø±ÙƒØªÙƒ Ø³ØªØ³Ø§Ø¹Ø¯Ù†Ø§ ÙÙŠ ØªØ­Ø³ÙŠÙ† Ø®Ø¯Ù…Ø§ØªÙ†Ø§.

Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹: [SURVEY_LINK]

Ø´ÙƒØ±Ø§Ù‹ Ù„ÙˆÙ‚ØªÙƒ
ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„</textarea>
                            </div>
                            <button class="btn btn-primary-custom w-100" onclick="sendEmail()">
                                <i class="fas fa-paper-plane me-2"></i>Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- SMS Distribution -->
                <div class="col-lg-6 mb-4">
                    <div class="distribution-card">
                        <div class="distribution-header">
                            <i class="fas fa-sms text-success-custom"></i>
                            <h4>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ©</h4>
                        </div>
                        <div class="distribution-body">
                            <textarea class="form-control mb-3" rows="3" id="phoneList" placeholder="Ø£Ø¯Ø®Ù„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆØ§ØªÙ (ÙˆØ§Ø­Ø¯ ÙÙŠ ÙƒÙ„ Ø³Ø·Ø±)&#10;+966501234567&#10;+966507654321"></textarea>
                            <div class="mb-3">
                                <label class="form-label">Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (160 Ø­Ø±Ù ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)</label>
                                <textarea class="form-control" rows="3" id="smsMessage" maxlength="160" placeholder="Ø´Ø§Ø±Ùƒ ÙÙŠ Ø§Ø³ØªØ·Ù„Ø§Ø¹Ù†Ø§: [SURVEY_LINK]">Ù…Ø±Ø­Ø¨Ø§Ù‹! Ù†Ø¯Ø¹ÙˆÙƒ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ø³Ø±ÙŠØ¹ Ù„ØªØ­Ø³ÙŠÙ† Ø®Ø¯Ù…Ø§ØªÙ†Ø§: [SURVEY_LINK]</textarea>
                                <small class="text-muted"><span id="smsCount">0</span>/160 Ø­Ø±Ù</small>
                            </div>
                            <button class="btn btn-success-custom w-100" onclick="sendSMS()">
                                <i class="fas fa-mobile-alt me-2"></i>Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ©
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- WhatsApp Distribution -->
                <div class="col-lg-6 mb-4">
                    <div class="distribution-card">
                        <div class="distribution-header">
                            <i class="fab fa-whatsapp" style="color: #25D366;"></i>
                            <h4>ÙˆØ§ØªØ³Ø§Ø¨</h4>
                        </div>
                        <div class="distribution-body">
                            <textarea class="form-control mb-3" rows="3" id="whatsappList" placeholder="Ø£Ø¯Ø®Ù„ Ø£Ø±Ù‚Ø§Ù… ÙˆØ§ØªØ³Ø§Ø¨ (ÙˆØ§Ø­Ø¯ ÙÙŠ ÙƒÙ„ Ø³Ø·Ø±)&#10;+966501234567&#10;+966507654321"></textarea>
                            <div class="mb-3">
                                <textarea class="form-control" rows="4" id="whatsappMessage" placeholder="Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨">Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…ØŒ

Ù†Ø£Ù…Ù„ Ù…Ù†Ùƒ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ù…Ù‡Ù… Ù„ØªØ·ÙˆÙŠØ± Ø®Ø¯Ù…Ø§ØªÙ†Ø§.

Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹: [SURVEY_LINK]

Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ ğŸ™</textarea>
                            </div>
                            <button class="btn w-100" style="background-color: #25D366; color: white;" onclick="sendWhatsApp()">
                                <i class="fab fa-whatsapp me-2"></i>Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- QR Code Generation -->
                <div class="col-lg-6 mb-4">
                    <div class="distribution-card">
                        <div class="distribution-header">
                            <i class="fas fa-qrcode text-info-custom"></i>
                            <h4>Ø±Ù…Ø² QR</h4>
                        </div>
                        <div class="distribution-body text-center">
                            <p class="text-muted mb-3">Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² QR Ù„Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ù„Ù…Ø´Ø§Ø±ÙƒØªÙ‡ ÙÙŠ Ø§Ù„Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ù…Ø§Ø¯ÙŠØ©</p>
                            <div class="qr-code-container mb-3" id="qrCodeContainer">
                                <div class="qr-placeholder">
                                    <i class="fas fa-qrcode" style="font-size: 4rem; color: #dee2e6;"></i>
                                    <p class="text-muted mt-2">Ø³ÙŠØ¸Ù‡Ø± Ø±Ù…Ø² QR Ù‡Ù†Ø§</p>
                                </div>
                            </div>
                            <button class="btn btn-info-custom w-100 mb-2" onclick="generateQRCode()">
                                <i class="fas fa-qrcode me-2"></i>Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² QR
                            </button>
                            <button class="btn btn-outline-info-custom w-100" onclick="downloadQR()" style="display: none;" id="downloadQRBtn">
                                <i class="fas fa-download me-2"></i>ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ù…Ø²
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="card-custom" id="resultsSection" style="display: none;">
            <div class="card-header-custom">
                <h3 class="card-title">
                    <i class="fas fa-chart-bar me-2"></i>
                    Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙˆØ²ÙŠØ¹
                </h3>
            </div>
            <div id="distributionResults">
                <!-- Results will be populated here -->
            </div>
        </div>
    </div>

    {% include 'components/scripts.html' %}
    
    <script>
    let selectedSurveyId = null;
    let generatedSurveyUrl = null;
    let currentSurveyUrl = null;
    
    // Initialize survey navigation
    document.addEventListener('DOMContentLoaded', function() {
        SurveyNavigation.setPage(
            'ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹Ø§Øª',
            'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³ØªØ·Ù„Ø§Ø¹ ÙˆÙŠØ¨ ÙˆØªÙˆØ²ÙŠØ¹Ù‡ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ© ÙˆÙˆØ§ØªØ³Ø§Ø¨ ÙˆØ±Ù…ÙˆØ² QR',
            [
                { title: 'Ø§Ù„ØªÙˆØ²ÙŠØ¹', url: '/surveys/distribution' }
            ]
        );
        SurveyNavigation.setActiveNav('surveys');
        SurveyActions.updateProgress(1, 3, 'Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹');
    });
    
    // SMS character counter
    document.getElementById('smsMessage').addEventListener('input', function() {
        const count = this.value.length;
        document.getElementById('smsCount').textContent = count;
    });
    
    // Password field toggle
    document.getElementById('requirePassword').addEventListener('change', function() {
        const passwordField = document.getElementById('surveyPassword');
        passwordField.style.display = this.checked ? 'block' : 'none';
    });
    
    // Survey selection
    function selectSurvey() {
        const surveySelect = document.getElementById('existingSurvey');
        selectedSurveyId = surveySelect.value;
        
        if (!selectedSurveyId) {
            alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³ØªØ·Ù„Ø§Ø¹');
            return;
        }
        
        // Get survey data from select option
        const selectedOption = surveySelect.options[surveySelect.selectedIndex];
        const surveyData = JSON.parse(selectedOption.getAttribute('data-survey'));
        
        // Calculate estimated time (1 minute per 2 questions)
        const estimatedMinutes = Math.max(1, Math.ceil(surveyData.questions_count / 2));
        const estimatedTime = estimatedMinutes === 1 ? 'Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©' : `${estimatedMinutes} Ø¯Ù‚Ø§Ø¦Ù‚`;
        
        // Show survey info
        document.getElementById('selectedSurveyInfo').innerHTML = `
            <div class="selected-survey-card">
                <h6><i class="fas fa-poll me-2"></i>${surveyData.title}</h6>
                <p class="text-muted mb-2">${surveyData.description || 'Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ù…Ø®ØµØµ'}</p>
                <div class="row">
                    <div class="col-md-6">
                        <small class="text-muted"><i class="fas fa-question-circle me-1"></i>${surveyData.questions_count} Ø£Ø³Ø¦Ù„Ø©</small>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted"><i class="fas fa-clock me-1"></i>${estimatedTime}</small>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="badge bg-${surveyData.status === 'published' ? 'success' : 'warning'}">${surveyData.status === 'published' ? 'Ù…Ù†Ø´ÙˆØ±' : 'Ù…Ø³ÙˆØ¯Ø©'}</small>
                    <small class="text-muted ms-2">ID: ${surveyData.short_id || surveyData.uuid.substring(0, 8)}</small>
                </div>
            </div>
        `;
        
        // Show survey preview
        document.getElementById('surveyPreview').innerHTML = `
            <div class="survey-preview-content">
                <h6>${surveyData.title}</h6>
                <p class="small text-muted">${surveyData.description || 'Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ù…Ø®ØµØµ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù†Ø´Ø¦ Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹Ø§Øª'}</p>
                <div class="preview-info">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-primary">${surveyData.questions_count} Ø£Ø³Ø¦Ù„Ø©</span>
                        <span class="small text-muted">${estimatedTime}</span>
                    </div>
                    <div class="mt-2">
                        <small class="text-success">âœ“ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù†Ø´Ø¦ Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹Ø§Øª</small>
                    </div>
                </div>
            </div>
        `;
        
        // Store the actual survey URL from database
        currentSurveyUrl = surveyData.public_url;
        
        // Show step 2
        document.getElementById('step2').style.display = 'block';
        document.getElementById('step2').scrollIntoView({ behavior: 'smooth' });
    }
    
    // Generate survey link
    function generateSurveyLink() {
        if (!selectedSurveyId) {
            alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ø£ÙˆÙ„Ø§Ù‹');
            return;
        }
        
        // Use the real survey URL from the database
        generatedSurveyUrl = `${window.location.origin}${currentSurveyUrl}`;
        
        // Show generated link
        document.getElementById('generatedUrl').value = generatedSurveyUrl;
        document.getElementById('generatedLinkSection').style.display = 'block';
        
        // Update placeholders in messages
        updateMessagePlaceholders();
        
        // Show step 3
        document.getElementById('step3').style.display = 'block';
        document.getElementById('step3').scrollIntoView({ behavior: 'smooth' });
        
        // Show success message
        showNotification('Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙˆØ²ÙŠØ¹!', 'success');
    }
    
    // Update message placeholders
    function updateMessagePlaceholders() {
        if (!generatedSurveyUrl) return;
        
        // Update email message
        const emailMessage = document.getElementById('emailMessage');
        emailMessage.value = emailMessage.value.replace('[SURVEY_LINK]', generatedSurveyUrl);
        
        // Update SMS message
        const smsMessage = document.getElementById('smsMessage');
        smsMessage.value = smsMessage.value.replace('[SURVEY_LINK]', generatedSurveyUrl);
        
        // Update WhatsApp message
        const whatsappMessage = document.getElementById('whatsappMessage');
        whatsappMessage.value = whatsappMessage.value.replace('[SURVEY_LINK]', generatedSurveyUrl);
    }
    
    // Copy to clipboard
    function copyToClipboard() {
        const urlField = document.getElementById('generatedUrl');
        urlField.select();
        document.execCommand('copy');
        showNotification('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©', 'info');
    }
    
    // Send email
    function sendEmail() {
        const emailList = document.getElementById('emailList').value.trim();
        const subject = document.getElementById('emailSubject').value;
        const message = document.getElementById('emailMessage').value;
        
        if (!emailList) {
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ');
            return;
        }
        
        const emails = emailList.split('\\n').filter(email => email.trim());
        
        // Simulate email sending
        showDistributionResult('email', `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ø¥Ù„Ù‰ ${emails.length} Ø¹Ù†ÙˆØ§Ù† Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ`);
    }
    
    // Send SMS
    function sendSMS() {
        const phoneList = document.getElementById('phoneList').value.trim();
        const message = document.getElementById('smsMessage').value;
        
        if (!phoneList) {
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆØ§ØªÙ');
            return;
        }
        
        const phones = phoneList.split('\\n').filter(phone => phone.trim());
        
        // Simulate SMS sending
        showDistributionResult('sms', `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ø¥Ù„Ù‰ ${phones.length} Ø±Ù‚Ù… Ù‡Ø§ØªÙ`);
    }
    
    // Send WhatsApp
    function sendWhatsApp() {
        const whatsappList = document.getElementById('whatsappList').value.trim();
        const message = document.getElementById('whatsappMessage').value;
        
        if (!whatsappList) {
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø±Ù‚Ø§Ù… ÙˆØ§ØªØ³Ø§Ø¨');
            return;
        }
        
        const numbers = whatsappList.split('\\n').filter(num => num.trim());
        
        // Simulate WhatsApp sending
        showDistributionResult('whatsapp', `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ø¥Ù„Ù‰ ${numbers.length} Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨`);
    }
    
    // Generate QR Code
    function generateQRCode() {
        if (!generatedSurveyUrl) {
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ø£ÙˆÙ„Ø§Ù‹');
            return;
        }
        
        // Generate QR code (using a simple placeholder)
        document.getElementById('qrCodeContainer').innerHTML = `
            <div class="qr-code-generated">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(generatedSurveyUrl)}" 
                     alt="QR Code" class="img-fluid">
            </div>
        `;
        
        document.getElementById('downloadQRBtn').style.display = 'block';
        showNotification('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² QR Ø¨Ù†Ø¬Ø§Ø­!', 'success');
    }
    
    // Download QR
    function downloadQR() {
        const link = document.createElement('a');
        link.download = 'survey-qr-code.png';
        link.href = `https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${encodeURIComponent(generatedSurveyUrl)}`;
        link.click();
    }
    
    // Show distribution result
    function showDistributionResult(channel, message) {
        const resultsSection = document.getElementById('resultsSection');
        const results = document.getElementById('distributionResults');
        
        const channelIcons = {
            email: 'fas fa-envelope',
            sms: 'fas fa-sms',
            whatsapp: 'fab fa-whatsapp'
        };
        
        const channelColors = {
            email: 'primary',
            sms: 'success',
            whatsapp: 'success'
        };
        
        results.innerHTML += `
            <div class="alert alert-${channelColors[channel]} d-flex align-items-center mb-2">
                <i class="${channelIcons[channel]} me-3"></i>
                <span>${message}</span>
                <small class="text-muted ms-auto">${new Date().toLocaleTimeString('ar-SA')}</small>
            </div>
        `;
        
        resultsSection.style.display = 'block';
        resultsSection.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Show notification
    function showNotification(message, type) {
        // Simple notification system
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.top = '20px';
        notification.style.left = '20px';
        notification.style.zIndex = '9999';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
    </script>
</body>
</html>