<!DOCTYPE html>
<html lang="{{ get_language_info().code }}" dir="{{ get_language_info().direction }}">
<head>
    {% include 'components/head.html' %}
    <title>{{ title }} - Voice of Customer Platform</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/unified-layout.css') }}">
<style>
/* Unified Survey Hub Styles */
.survey-hub-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
}

.tab-navigation {
    display: flex;
    border-bottom: 2px solid #e2e8f0;
    margin-bottom: 2rem;
    gap: 1rem;
}

.tab-button {
    padding: 1rem 2rem;
    background: none;
    border: none;
    font-size: 1.1rem;
    font-weight: 600;
    color: #64748b;
    cursor: pointer;
    position: relative;
    transition: all 0.3s ease;
}

.tab-button.active {
    color: #3b82f6;
}

.tab-button.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background: #3b82f6;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.dashboard-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 1px solid #e2e8f0;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #64748b;
    font-size: 0.9rem;
}

.survey-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-top: 2rem;
}

.survey-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 1px solid #e2e8f0;
    transition: all 0.3s ease;
}

.survey-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.survey-header {
    display: flex;
    justify-content: between;
    align-items: start;
    margin-bottom: 1rem;
}

.survey-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 0.5rem;
}

.survey-meta {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    color: #64748b;
}

.survey-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.btn-unified {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 500;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
    cursor: pointer;
    border: none;
}

.btn-primary {
    background: #3b82f6;
    color: white;
}

.btn-primary:hover {
    background: #2563eb;
    color: white;
}

.btn-success {
    background: #10b981;
    color: white;
}

.btn-success:hover {
    background: #059669;
    color: white;
}

.btn-outline {
    background: transparent;
    color: #64748b;
    border: 1px solid #e2e8f0;
}

.btn-outline:hover {
    background: #f8fafc;
    color: #1e293b;
}

.status-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.status-published {
    background: #dcfce7;
    color: #16a34a;
}

.status-draft {
    background: #fef3c7;
    color: #d97706;
}

.quick-actions {
    margin-top: 2rem;
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.create-new-card {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    width: 100%;
    max-width: 350px;
}

.create-new-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
}

.create-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.create-title {
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.create-subtitle {
    font-size: 0.9rem;
    opacity: 0.9;
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: #64748b;
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    color: #cbd5e1;
}
</style>
</head>
<body>
    {% include 'components/unified_navigation.html' %}
<div class="survey-hub-container">
    <!-- Page Header -->
    <div class="page-header mb-4">
        <h1 class="page-title">مركز إدارة الاستطلاعات</h1>
        <p class="page-subtitle">إدارة شاملة - إنشاء، توزيع، تحليل</p>
    </div>

    <!-- Dashboard Statistics -->
    <div class="dashboard-stats">
        <div class="stat-card">
            <div class="stat-value">{{ stats.total_surveys }}</div>
            <div class="stat-label">إجمالي الاستطلاعات</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.active_surveys }}</div>
            <div class="stat-label">الاستطلاعات النشطة</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.total_responses }}</div>
            <div class="stat-label">إجمالي الاستجابات</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ "%.1f"|format(stats.avg_completion_rate) }}%</div>
            <div class="stat-label">معدل الإكمال</div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <button class="tab-button active" data-tab="management">
            <i class="fas fa-tasks me-2"></i>إدارة الاستطلاعات
        </button>
        <button class="tab-button" data-tab="builder">
            <i class="fas fa-plus me-2"></i>منشئ الاستطلاعات
        </button>
        <button class="tab-button" data-tab="responses">
            <i class="fas fa-chart-bar me-2"></i>الاستجابات والتحليلات
        </button>
    </div>

    <!-- Management Tab -->
    <div class="tab-content active" id="management-tab">
        <!-- Quick Actions -->
        <div class="quick-actions">
            <button class="create-new-card" onclick="window.location.href='/surveys/builder'">
                <div class="create-icon">
                    <i class="fas fa-plus-circle"></i>
                </div>
                <div class="create-title">إنشاء استطلاع جديد</div>
                <div class="create-subtitle">ابدأ في إنشاء استطلاع تفاعلي جديد</div>
            </button>
        </div>

        <!-- Survey Grid -->
        <div class="survey-grid">
            {% if surveys %}
                {% for survey in surveys %}
                <div class="survey-card" data-survey-id="{{ survey.id }}">
                    <div class="survey-header">
                        <div>
                            <div class="survey-title">{{ survey.title }}</div>
                            <div class="survey-meta">
                                <span><i class="fas fa-questions me-1"></i>{{ survey.question_count }} سؤال</span>
                                <span><i class="fas fa-users me-1"></i>{{ survey.response_count }} استجابة</span>
                                <span class="status-badge status-{{ survey.status }}">
                                    {% if survey.status == 'published' %}منشور{% else %}مسودة{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    {% if survey.description %}
                    <p class="text-muted mb-3">{{ survey.description[:100] }}{% if survey.description|length > 100 %}...{% endif %}</p>
                    {% endif %}
                    
                    <div class="survey-actions">
                        <a href="/surveys/builder?id={{ survey.id }}" class="btn-unified btn-outline">
                            <i class="fas fa-edit"></i>تحرير
                        </a>
                        {% if survey.public_url %}
                        <a href="{{ survey.public_url }}" target="_blank" class="btn-unified btn-success">
                            <i class="fas fa-external-link-alt"></i>معاينة
                        </a>
                        {% endif %}
                        <button class="btn-unified btn-primary" onclick="showDistributionPanel('{{ survey.id }}')">
                            <i class="fas fa-share-alt"></i>توزيع
                        </button>
                        <a href="/surveys/responses?survey_id={{ survey.id }}" class="btn-unified btn-outline">
                            <i class="fas fa-chart-line"></i>التحليلات
                        </a>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-poll"></i>
                    <h3>لا توجد استطلاعات حتى الآن</h3>
                    <p>ابدأ في إنشاء أول استطلاع لك</p>
                    <button class="btn-unified btn-primary mt-3" onclick="window.location.href='/surveys/builder'">
                        <i class="fas fa-plus me-2"></i>إنشاء استطلاع جديد
                    </button>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Builder Tab -->
    <div class="tab-content" id="builder-tab">
        <div class="text-center py-5">
            <h3>منشئ الاستطلاعات</h3>
            <p class="text-muted mb-4">أنشئ استطلاعات تفاعلية باستخدام أدوات السحب والإفلات</p>
            <button class="btn-unified btn-primary" onclick="window.location.href='/surveys/builder'">
                <i class="fas fa-plus me-2"></i>ابدأ الإنشاء الآن
            </button>
        </div>
    </div>

    <!-- Responses Tab -->
    <div class="tab-content" id="responses-tab">
        <div class="text-center py-5">
            <h3>الاستجابات والتحليلات</h3>
            <p class="text-muted mb-4">عرض وتحليل استجابات الاستطلاعات</p>
            <button class="btn-unified btn-primary" onclick="window.location.href='/surveys/responses'">
                <i class="fas fa-chart-bar me-2"></i>عرض التحليلات
            </button>
        </div>
    </div>
</div>

<!-- Distribution Modal -->
<div class="modal fade" id="distributionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">توزيع الاستطلاع</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>مشاركة سريعة</h6>
                        <div class="mb-3">
                            <label class="form-label">رابط الاستطلاع</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="surveyLink" readonly>
                                <button class="btn btn-outline-secondary" onclick="copyToClipboard('surveyLink')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <button class="btn btn-success me-2" onclick="generateQRCode()">
                                <i class="fas fa-qrcode me-1"></i>رمز QR
                            </button>
                            <button class="btn btn-primary" onclick="emailBlast()">
                                <i class="fas fa-envelope me-1"></i>إرسال بالبريد
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>حملة متقدمة</h6>
                        <p class="text-muted small">إنشاء حملة مخصصة مع جدولة وتتبع متقدم</p>
                        <button class="btn btn-primary" onclick="createAdvancedCampaign()">
                            <i class="fas fa-rocket me-1"></i>إنشاء حملة
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    {% include 'components/scripts.html' %}
<script>
// Unified Survey Hub JavaScript
class SurveyHub {
    constructor() {
        this.currentSurveyId = null;
        this.init();
    }

    init() {
        // Tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', (e) => {
                this.switchTab(e.target.dataset.tab);
            });
        });

        // Initialize modals
        this.distributionModal = new bootstrap.Modal(document.getElementById('distributionModal'));
    }

    switchTab(tabName) {
        // Update button states
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

        // Show content
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    async loadDashboardStats() {
        try {
            const response = await fetch('/api/surveys/dashboard-stats');
            const data = await response.json();
            this.updateStatsDisplay(data);
        } catch (error) {
            console.error('Error loading dashboard stats:', error);
        }
    }

    updateStatsDisplay(stats) {
        // Update stat cards with real data
        document.querySelector('.stat-card:nth-child(1) .stat-value').textContent = stats.total_surveys;
        document.querySelector('.stat-card:nth-child(2) .stat-value').textContent = stats.active_surveys;
        document.querySelector('.stat-card:nth-child(3) .stat-value').textContent = stats.total_responses;
        document.querySelector('.stat-card:nth-child(4) .stat-value').textContent = stats.avg_completion_rate + '%';
    }
}

// Distribution functions
function showDistributionPanel(surveyId) {
    window.surveyHub.currentSurveyId = surveyId;
    
    // Get survey public URL
    const surveyCard = document.querySelector(`[data-survey-id="${surveyId}"]`);
    const publicUrl = surveyCard.querySelector('.btn-success')?.href || '';
    
    document.getElementById('surveyLink').value = publicUrl;
    window.surveyHub.distributionModal.show();
}

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    element.select();
    document.execCommand('copy');
    
    // Show success message
    const btn = element.nextElementSibling;
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check"></i>';
    setTimeout(() => {
        btn.innerHTML = originalHTML;
    }, 2000);
}

function generateQRCode() {
    const surveyLink = document.getElementById('surveyLink').value;
    if (surveyLink) {
        window.open(`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(surveyLink)}`, '_blank');
    }
}

function emailBlast() {
    const surveyId = window.surveyHub.currentSurveyId;
    if (surveyId) {
        window.location.href = `/contacts?action=email-blast&survey_id=${surveyId}`;
    }
}

function createAdvancedCampaign() {
    const surveyId = window.surveyHub.currentSurveyId;
    if (surveyId) {
        window.location.href = `/surveys/campaigns/create?survey_id=${surveyId}`;
    }
}

// Initialize on DOM ready
document.addEventListener('DOMContentLoaded', () => {
    window.surveyHub = new SurveyHub();
    
    // Load real-time stats
    window.surveyHub.loadDashboardStats();
    
    // Refresh stats every 30 seconds
    setInterval(() => {
        window.surveyHub.loadDashboardStats();
    }, 30000);
});
</script>
</body>
</html>